---
title: Creating Tables and Policies
excerpt: 
status: published
---
<script>
	import Homework from "$lib/components/Homework.svelte";
	import LessonPlan from "$lib/components/LessonPlan.svelte";
	import LabTime from "$lib/components/LabTime.svelte";
	import Achievement from "$lib/components/Achievement.svelte";
</script>


<LessonPlan {status}>

## 1. Demo: RLS and Policies
<dl>
	<dt>RLS</dt>
	<dd>Row-level Security is PostgreSQL's (the database engine used by Supabase) method of auth for each row of a database table.</dd>
	<dt>Access Policies</dt>
	<dd>PostgreSQL's method of allowing access to each row in a database table.</dd>
</dl>

### Key Takeaways
- If RLS is disabled on a table, anyone can read/write/edit records in the table.
- Once RLS is enabled on a table, _no one_ can read/write/edit records in a table.
- A Policy is required on RLS-enabled tables before anyone can read/write/edit records in a table.

It this course we will _enable_ RLS and set Policies so that anyone with an <anon> token can read a table but no one can write or edit a table unless they are using the admin panel.

---

## 2. Authentication vs Authorization
[![Slides - Authentication vs Authorization](/images/slides/authentication-vs-authorization.png)](https://sait-wbdv.github.io/slides/w23/cpnt-200/authentication-authorization.html)

### Materials
- [Part One: JWTs](https://supabase.com/docs/learn/auth-deep-dive/auth-deep-dive-jwts)
- [Part Two: Row Level Security](https://supabase.com/docs/learn/auth-deep-dive/auth-row-level-security)
- [Part Three: Policies](https://supabase.com/docs/learn/auth-deep-dive/auth-policies)

### Key Takaways
- In _Supabase_:
		- Authentication happens first with the <anon> `apiKey` token.
		- Authorization happens second with the `Authorization` Bearer token.
- Even if RLS is _Disabled_, users still need an <anon> API key to read or make changes to a database table.

---

## 3. Importing a database using CSVs
### Materials
- [RPG Players](https://docs.google.com/spreadsheets/d/1fl8swPUfXc1rwv73wra7XqiZBGnHOmuQovDoJ1FtMF8/edit?usp=sharing)

### Instructions
1. Export each Google Sheet as a CSV file;
2. In Supabase, create each table by importing its respective CSV and:
		- _Enable_ RLS;
		- set `id` as primary;
		- set an appropriate data type (use `text` instead of `varchar`);
		- allow `NULL` as needed.
3. Add a policy to each table that allows anyone to read the table.

</LessonPlan>

<Achievement {status} dueDate={false}>

Due tonight (Wednesday) at 11:59pm in Brightspace.

## Achievement 5
### 5 points: Import RPG Database from CSV
Using the Supabase admin panel, create a database based on one of the Google Sheets covered this week:
- [The Office](https://docs.google.com/spreadsheets/d/1ARDRrwVdeGgTMx5f0sLcnV6MliOf9UqYjWOEMLKOm4M)
- [RPG Players](https://docs.google.com/spreadsheets/d/1fl8swPUfXc1rwv73wra7XqiZBGnHOmuQovDoJ1FtMF8/edit?usp=sharing)

**Requirements**
- Every table should:
		- have RLS _Enabled_ and have a policy that allows anyone to Read (i.e. `SELECT`) data from the table.
		- have a Primary Key on the `id` column;
- Every column should:
		- have a lower-case name prepended with either `office_` or `rpg_`, depending on the Google Sheet chosen;
		- have an appropriate data type defined;
- Every one-to-many relationship should:
		- have an appropriately named column on the "One" side, usually [table_name]_id (i.e. `race_id` or `branch_id`);
		- have a foreign key defined on the "One" side (i.e. `race_id` or `branch_id`) that references an `id` of another table;
- Every many-to-many relationship should have a third _join_ table that has one-to-many to each of the other two tables.

**Submission Instructions**
Submit which Google Sheet you chose as a comment in Brightspace.

---

## Achievement 6
### 10 points: Google Sheet database
Create a draft database in a Google Sheet based on your ER Diagram from Achievement 3.

**Requirements**
Define at least 5 Sheets that:
- Define each column defined in your ER Diagram;
- each have a primary key defined as a `id` column;
- have at least one join table that defines a many-to-many relationship between two other tables;
- have at least two one-to-many relationships;
- conforms to proper naming conventions:
		- all names should be lowercase with underscores;
		- primary keys should be named `id`;
		- foreign key column names should be appended with `_id`

Additionally, each table should include an appropriate number of rows (records):
- At least one table should have at least 9 items that can be listed on a gallery page;
- One _join_ table should have more than 9 rows to support many-to-many relationships;
- Other tables should have at least 3 rows to support one-to-many relationships.

**Submission Instructions**
Submit a share link to your Google Sheet as a comment in Brightspace.

</Achievement>

<Homework {status}>

## Prep
### Reading list
- Supabase Documentation:
		- [Tables and Data](https://supabase.com/docs/guides/database/tables)
		- [Row Level Security](https://supabase.com/docs/guides/auth/row-level-security)
		- Reference: [Javascript Client Library](https://supabase.com/docs/reference/javascript/introduction)

### Watch list
**Supabase Auth Deep Dive**
- [Part One: JWTs](https://supabase.com/docs/learn/auth-deep-dive/auth-deep-dive-jwts)
- [Part Two: Row Level Security](https://supabase.com/docs/learn/auth-deep-dive/auth-row-level-security)
- [Part Three: Policies](https://supabase.com/docs/learn/auth-deep-dive/auth-policies)

</Homework>